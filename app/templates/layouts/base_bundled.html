<!DOCTYPE html>
<html lang="ko" data-theme="{{ session.get('theme', 'light') }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="{% block meta_description %}ÏûêÏÇ∞ Í¥ÄÎ¶¨ ÏãúÏä§ÌÖú{% endblock %}">
    <meta name="keywords" content="{% block meta_keywords %}ÏûêÏÇ∞Í¥ÄÎ¶¨, Ïû¨Í≥†Í¥ÄÎ¶¨, ÏãúÏÑ§Í¥ÄÎ¶¨{% endblock %}">
    
    <!-- Critical CSS (Ïù∏ÎùºÏù∏) -->
    {% set critical_css = get_critical_css_inline(page_name) %}
    {% if critical_css %}
    <style>{{ critical_css | safe }}</style>
    {% endif %}
    
    <!-- CSS Î≤àÎì§ Î°úÎìú -->
    {{ css_links(page_name=page_name, preload_next=preload_page) | safe }}
    
    <!-- Ìè∞Ìä∏ ÌîÑÎ¶¨Î°úÎìú -->
    <link rel="preload" href="{{ url_for('static', filename='fonts/NotoSansKR-Regular.woff2') }}" as="font" type="font/woff2" crossorigin>
    <link rel="preload" href="{{ url_for('static', filename='fonts/NotoSansKR-Medium.woff2') }}" as="font" type="font/woff2" crossorigin>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='images/favicon.ico') }}">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='images/apple-touch-icon.png') }}">
    
    <!-- ÌéòÏù¥ÏßÄÎ≥Ñ Î©îÌÉÄ Îç∞Ïù¥ÌÑ∞ -->
    {% block meta %}{% endblock %}
    
    <title>{% block title %}ÏûêÏÇ∞ Í¥ÄÎ¶¨ ÏãúÏä§ÌÖú{% endblock %}</title>
    
    <!-- Í∞úÎ∞ú Î™®ÎìúÏóêÏÑúÎßå ÏÜåÏä§Îßµ Î°úÎìú -->
    {% if IS_DEV %}
    <script>
        console.log('CSS Bundle Version: {{ CSS_VERSION }}');
        console.log('Page Bundle: {{ page_name or "none" }}');
    </script>
    {% endif %}
</head>
<body class="{% block body_class %}{% endblock %}">
    <!-- Î°úÎî© Ïò§Î≤ÑÎ†àÏù¥ -->
    <div id="loading-overlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner">
            <div class="spinner"></div>
            <p>Î°úÎî© Ï§ë...</p>
        </div>
    </div>
    
    <!-- Ïä§ÌÇµ ÎßÅÌÅ¨ (Ï†ëÍ∑ºÏÑ±) -->
    <a href="#main-content" class="skip-link">Î©îÏù∏ ÏΩòÌÖêÏ∏†Î°ú Í±¥ÎÑàÎõ∞Í∏∞</a>
    
    <!-- ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò -->
    {% if not hide_navigation %}
    {% include 'components/navigation.html' %}
    {% endif %}
    
    <!-- ÌîåÎûòÏãú Î©îÏãúÏßÄ -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div class="flash-messages" role="alert" aria-live="polite">
            {% for category, message in messages %}
            <div class="alert alert--{{ category }} alert--dismissible">
                <div class="alert__content">
                    <i class="alert__icon fas fa-{% if category == 'error' %}exclamation-triangle{% elif category == 'success' %}check-circle{% elif category == 'warning' %}exclamation-circle{% else %}info-circle{% endif %}"></i>
                    <span class="alert__message">{{ message }}</span>
                </div>
                <button type="button" class="alert__close" aria-label="Îã´Í∏∞">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    {% endwith %}
    
    <!-- Î©îÏù∏ ÏΩòÌÖêÏ∏† -->
    <main id="main-content" class="main-content {% block main_class %}{% endblock %}" role="main">
        {% block content %}{% endblock %}
    </main>
    
    <!-- Ìë∏ÌÑ∞ -->
    {% if not hide_footer %}
    {% include 'components/footer.html' %}
    {% endif %}
    
    <!-- Îã§ÌÅ¨ Î™®Îìú ÌÜ†Í∏Ä (Ï†ÑÏó≠) -->
    <button id="theme-toggle" class="theme-toggle" aria-label="Îã§ÌÅ¨ Î™®Îìú Ï†ÑÌôò">
        <i class="fas fa-moon theme-toggle__icon theme-toggle__icon--dark"></i>
        <i class="fas fa-sun theme-toggle__icon theme-toggle__icon--light"></i>
    </button>
    
    <!-- JavaScript Î≤àÎì§ (Ìñ•ÌõÑ Íµ¨ÌòÑ) -->
    <script src="{{ url_for('static', filename='js/core.min.js') }}" defer></script>
    {% block scripts %}{% endblock %}
    
    <!-- ÌéòÏù¥ÏßÄÎ≥Ñ JavaScript -->
    {% if page_name %}
    <script src="{{ url_for('static', filename='js/pages/' + page_name + '.min.js') }}" defer></script>
    {% endif %}
    
    <!-- Í∞úÎ∞ú Î™®Îìú ÎîîÎ≤ÑÍπÖ ÎèÑÍµ¨ -->
    {% if IS_DEV %}
    <div id="dev-tools" class="dev-tools">
        <button class="dev-tools__toggle">üõ†Ô∏è</button>
        <div class="dev-tools__panel">
            <h4>Development Tools</h4>
            <p><strong>Page:</strong> {{ page_name or 'unknown' }}</p>
            <p><strong>Bundle Version:</strong> {{ CSS_VERSION }}</p>
            <p><strong>Theme:</strong> {{ session.get('theme', 'light') }}</p>
            <button onclick="location.reload()">Reload</button>
            <button onclick="toggleTheme()">Toggle Theme</button>
        </div>
    </div>
    {% endif %}
    
    <!-- Í∏∞Î≥∏ JavaScript (Ïù∏ÎùºÏù∏) -->
    <script>
        // ÌÖåÎßà ÌÜ†Í∏Ä Í∏∞Îä•
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme') || 'light';
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            
            html.setAttribute('data-theme', newTheme);
            
            // ÏÑúÎ≤ÑÏóê ÌÖåÎßà ÏÑ§Ï†ï Ï†ÄÏû•
            fetch('{{ url_for("main.set_theme") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                },
                body: JSON.stringify({ theme: newTheme })
            });
        }
        
        // ÌÖåÎßà ÌÜ†Í∏Ä Î≤ÑÌäº Ïù¥Î≤§Ìä∏
        document.getElementById('theme-toggle')?.addEventListener('click', toggleTheme);
        
        // ÌîåÎûòÏãú Î©îÏãúÏßÄ ÏûêÎèô Îã´Í∏∞
        document.querySelectorAll('.alert--dismissible .alert__close').forEach(button => {
            button.addEventListener('click', function() {
                this.closest('.alert').remove();
            });
        });
        
        // Î°úÎî© Ïò§Î≤ÑÎ†àÏù¥ Ï†úÏñ¥
        window.showLoading = function() {
            document.getElementById('loading-overlay').style.display = 'flex';
        };
        
        window.hideLoading = function() {
            document.getElementById('loading-overlay').style.display = 'none';
        };
        
        // ÌéòÏù¥ÏßÄ Î°úÎìú ÏôÑÎ£å ÌõÑ Î°úÎî© Ïà®ÍπÄ
        window.addEventListener('load', hideLoading);
        
        // Í∞úÎ∞ú ÎèÑÍµ¨ ÌÜ†Í∏Ä (Í∞úÎ∞ú Î™®Îìú)
        {% if IS_DEV %}
        document.querySelector('.dev-tools__toggle')?.addEventListener('click', function() {
            const panel = document.querySelector('.dev-tools__panel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        });
        {% endif %}
        
        // CSS Î°úÎìú ÏµúÏ†ÅÌôî - Ìè∞Ìä∏ ÌëúÏãú Í∞úÏÑ†
        if ('fonts' in document) {
            document.fonts.ready.then(() => {
                document.body.classList.add('fonts-loaded');
            });
        }
        
        // ÏÑúÎπÑÏä§ ÏõåÏª§ Îì±Î°ù (ÌîÑÎ°úÎçïÏÖò Î™®Îìú)
        {% if not IS_DEV %}
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').catch(err => {
                    console.log('ServiceWorker registration failed:', err);
                });
            });
        }
        {% endif %}
    </script>
</body>
</html>