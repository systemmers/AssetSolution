{% extends "base.html" %}

{% block title %}사용자 관리 - 자산관리 시스템{% endblock %}

{% block page_header %}
<div class="page__header">
    <div>
        <h2 class="page__title">사용자 관리</h2>
        <p class="page__subtitle">시스템 사용자 계정 및 권한 관리</p>
    </div>
    <div class="page__actions">
        <a href="{{ url_for('users.create') }}" class="btn btn-primary">
            <i class="fas fa-user-plus"></i> 사용자 등록
        </a>
    </div>
</div>
{% endblock %}

{% block content %}
<!-- 새로운 매크로 시스템 사용 -->
{% from 'macros/forms.html' import form_group, form_select, form_input %}
{% from 'macros/buttons.html' import btn %}
{% from 'macros/tables.html' import data_table %}

<div class="list-layout">
    <!-- 필터 섹션 -->
    <div class="filter-section">
        <div class="filter-section__header">
            <h3 class="filter-section__title">검색 및 필터</h3>
            <div class="filter-section__actions">
                {{ btn('초기화', variant='text', icon='fa-undo', id='resetButton') }}
            </div>
        </div>
        
        <form id="searchForm" method="GET" action="{{ url_for('users.index') }}" class="filter-section__form">
            <div class="filter-section__grid filter-section__grid--4">
                <!-- 검색어 입력 -->
                {{ form_group(
                    label='검색어',
                    control=form_input(
                        name='q',
                        placeholder='사용자명, 이메일, 아이디',
                        value=request.args.get('q', ''),
                        id='searchKeyword'
                    )
                ) }}
                
                <!-- 부서 선택 -->
                {{ form_group(
                    label='부서',
                    control=form_select(
                        name='department',
                        options=[
                            {'value': '', 'label': '전체'},
                            {'value': '1', 'label': '개발팀'},
                            {'value': '2', 'label': '인사팀'},
                            {'value': '3', 'label': '마케팅팀'},
                            {'value': '4', 'label': 'IT팀'},
                            {'value': '5', 'label': '경영지원팀'},
                            {'value': '6', 'label': '영업팀'}
                        ],
                        selected=request.args.get('department', ''),
                        id='departmentFilter'
                    )
                ) }}
                
                <!-- 역할 선택 -->
                {{ form_group(
                    label='역할',
                    control=form_select(
                        name='role',
                        options=[
                            {'value': '', 'label': '전체'},
                            {'value': '1', 'label': '관리자'},
                            {'value': '2', 'label': '일반사용자'},
                            {'value': '3', 'label': '조회전용'}
                        ],
                        selected=request.args.get('role', ''),
                        id='roleFilter'
                    )
                ) }}
                
                <!-- 검색 버튼 -->
                <div class="filter-section__actions-primary">
                    {{ btn('검색', variant='primary', icon='fa-search', type='submit') }}
                </div>
            </div>
        </form>
    </div>

    <!-- 결과 요약 및 액션 -->
    <div class="list-layout__toolbar">
        <div class="list-layout__info">
            <span class="text-muted">총 {{ users|length }}명의 사용자</span>
            {% if request.args.get('q') or request.args.get('department') or request.args.get('role') %}
            <span class="status-badge status-badge--info">필터 적용됨</span>
            {% endif %}
        </div>
        
        <div class="list-layout__actions">
            {{ btn('엑셀 내보내기', variant='outline-primary', icon='fa-file-excel', id='btnExportExcel') }}
        </div>
    </div>

    <!-- 컨텐츠 섹션 -->
    <div class="content-section">
        <div class="content-section__body content-section--flush">
            {% if users %}
                {% set headers = [
                    {'label': 'ID', 'sortable': true},
                    {'label': '이름', 'sortable': true},
                    {'label': '사용자명', 'sortable': true},
                    {'label': '이메일', 'sortable': true},
                    {'label': '부서'},
                    {'label': '역할', 'class': 'table__cell--center'},
                    {'label': '상태', 'class': 'table__cell--center'},
                    {'label': '관리', 'class': 'table__cell--center'}
                ] %}
                
                {% set rows = [] %}
                {% for user in users %}
                    {% set role_badge = {
                        1: '<span class="status-badge status-badge--primary">관리자</span>',
                        2: '<span class="status-badge status-badge--success">일반사용자</span>',
                        3: '<span class="status-badge status-badge--secondary">조회전용</span>'
                    }.get(user.role.id if user.role else 0, '<span class="status-badge status-badge--inactive">-</span>') %}
                    
                    {% set status_badge = '<span class="status-badge status-badge--success">활성</span>' if user.is_active else '<span class="status-badge status-badge--danger">비활성</span>' %}
                    
                    {% set action_buttons = '<div class="btn-group">' +
                        '<a href="' + url_for('users.detail', user_id=user.id) + '" class="btn btn-sm btn-outline-primary"><i class="fas fa-eye"></i></a>' +
                        '<a href="' + url_for('users.edit', user_id=user.id) + '" class="btn btn-sm btn-outline-secondary"><i class="fas fa-edit"></i></a>' +
                        '</div>' %}
                    
                    {% set _ = rows.append([
                        user.id,
                        user.name,
                        '<span class="user-code">' + user.username + '</span>',
                        '<a href="mailto:' + user.email + '" class="text-decoration-none">' + user.email + '</a>',
                        user.department.name if user.department else '-',
                        role_badge,
                        status_badge,
                        action_buttons
                    ]) %}
                {% endfor %}
                
                {{ data_table(
                    headers=headers,
                    rows=rows,
                    variant='hover',
                    responsive=true,
                    clickable=true
                ) }}
            {% else %}
                <div class="empty-state">
                    <div class="empty-state__icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="empty-state__title">등록된 사용자가 없습니다</div>
                    <div class="empty-state__description">사용자 등록 버튼을 클릭하여 첫 번째 사용자를 등록하세요.</div>
                    <div class="empty-state__action">
                        {{ btn('사용자 등록', variant='primary', icon='fa-user-plus', url=url_for('users.create')) }}
                    </div>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- 사용자 통계 -->
    <div class="content-section">
        <div class="content-section__header">
            <h3 class="content-section__title">사용자 통계</h3>
        </div>
        <div class="content-section__body">
            <div class="user-statistics">
                <div class="user-stat">
                    <div class="user-stat__icon user-stat__icon--primary">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="user-stat__content">
                        <div class="user-stat__value">{{ users|length }}</div>
                        <div class="user-stat__label">전체 사용자</div>
                    </div>
                </div>
                
                <div class="user-stat">
                    <div class="user-stat__icon user-stat__icon--success">
                        <i class="fas fa-user-check"></i>
                    </div>
                    <div class="user-stat__content">
                        <div class="user-stat__value">{{ users|selectattr('is_active')|list|length }}</div>
                        <div class="user-stat__label">활성 사용자</div>
                    </div>
                </div>
                
                <div class="user-stat">
                    <div class="user-stat__icon user-stat__icon--warning">
                        <i class="fas fa-user-shield"></i>
                    </div>
                    <div class="user-stat__content">
                        <div class="user-stat__value">{{ users|selectattr('role.id', 'equalto', 1)|list|length if users else 0 }}</div>
                        <div class="user-stat__label">관리자</div>
                    </div>
                </div>
                
                <div class="user-stat">
                    <div class="user-stat__icon user-stat__icon--info">
                        <i class="fas fa-building"></i>
                    </div>
                    <div class="user-stat__content">
                        <div class="user-stat__value">6</div>
                        <div class="user-stat__label">부서 수</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 최근 활동 -->
    <div class="content-section">
        <div class="content-section__header">
            <h3 class="content-section__title">최근 사용자 활동</h3>
        </div>
        <div class="content-section__body">
            <div class="activity-timeline">
                <div class="activity-item">
                    <div class="activity-item__content">
                        <div class="activity-item__header">
                            <div class="activity-item__title">새 사용자 등록</div>
                            <div class="activity-item__time">오늘</div>
                        </div>
                        <div class="activity-item__description">
                            김신입 (개발팀) 계정 생성<br>
                            <small>등록자: 관리자</small>
                        </div>
                    </div>
                </div>
                
                <div class="activity-item">
                    <div class="activity-item__content">
                        <div class="activity-item__header">
                            <div class="activity-item__title">권한 변경</div>
                            <div class="activity-item__time">어제</div>
                        </div>
                        <div class="activity-item__description">
                            이개발 권한을 일반사용자 → 관리자로 승격<br>
                            <small>변경자: 시스템관리자</small>
                        </div>
                    </div>
                </div>
                
                <div class="activity-item">
                    <div class="activity-item__content">
                        <div class="activity-item__header">
                            <div class="activity-item__title">계정 비활성화</div>
                            <div class="activity-item__time">3일 전</div>
                        </div>
                        <div class="activity-item__description">
                            박퇴사 계정 비활성화 처리<br>
                            <small>처리자: 인사팀</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/users/index.new.css') }}">
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/pages/users/index.js') }}"></script>
{% endblock %}