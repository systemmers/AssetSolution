{% extends "base.html" %}

{% block title %}대시보드 - 자산관리 시스템{% endblock %}

{% block page_header %}
<div class="page__header">
    <div>
        <h2 class="page__title">대시보드</h2>
        <p class="page__subtitle">기준일: <strong>{{ current_date }}</strong></p>
    </div>
    <div class="page__actions">
        <button class="btn btn-outline-primary btn-sm">
            <i class="fas fa-download"></i> 보고서 내보내기
        </button>
        <button class="btn btn-primary">
            <i class="fas fa-plus"></i> 빠른 등록
        </button>
    </div>
</div>
{% endblock %}

{% block content %}
<!-- 새로운 매크로 시스템 사용 -->
{% from 'macros/cards.html' import stat_card %}
{% from 'macros/tables.html' import data_table, simple_table %}
{% from 'macros/buttons.html' import btn %}

<div class="dashboard-layout">
    <!-- 통계 카드 섹션 -->
    <div class="dashboard-layout__stats">
        <div class="summary-cards">
            {{ stat_card(
                title='총 자산',
                value=total_assets,
                icon='fa-boxes',
                color='primary',
                trend='+5.2%'
            ) }}
            
            {{ stat_card(
                title='정상 자산',
                value=normal_assets,
                icon='fa-check-circle',
                color='success',
                trend='+2.1%'
            ) }}
            
            {{ stat_card(
                title='수리중',
                value=maintenance_assets,
                icon='fa-tools',
                color='warning',
                trend='-1.3%'
            ) }}
            
            {{ stat_card(
                title='폐기 예정',
                value=disposed_assets,
                icon='fa-trash-alt',
                color='danger',
                trend='0%'
            ) }}
        </div>
        
        <!-- 계약 통계 카드 -->
        <div class="summary-cards">
            {{ stat_card(
                title='총 계약',
                value=total_contracts,
                icon='fa-file-contract',
                color='info',
                trend='+3.4%'
            ) }}
            
            {{ stat_card(
                title='진행중 계약',
                value=active_contracts,
                icon='fa-clipboard-check',
                color='success',
                trend='+1.2%'
            ) }}
            
            {{ stat_card(
                title='만료 임박',
                value=expiring_contracts,
                icon='fa-exclamation-triangle',
                color='warning',
                trend='+2건'
            ) }}
            
            {{ stat_card(
                title='월간 계약비용',
                value='₩ {:,.0f}'.format(monthly_cost),
                icon='fa-won-sign',
                color='primary',
                trend='-2.1%'
            ) }}
        </div>
    </div>

    <!-- 메인 콘텐츠 -->
    <div class="dashboard-layout__main">
        <div class="dashboard-layout__primary">
            <!-- 최근 등록 자산 -->
            <div class="content-section">
                <div class="content-section__header">
                    <h3 class="content-section__title">최근 등록 자산</h3>
                    <div class="content-section__actions">
                        {{ btn('전체보기', variant='primary', size='sm', url=url_for('assets.index')) }}
                    </div>
                </div>
                <div class="content-section__body content-section--flush">
                    {% if recent_assets %}
                        {% set headers = [
                            {'label': '자산번호', 'sortable': true},
                            {'label': '자산명', 'sortable': true},
                            {'label': '카테고리', 'sortable': true},
                            {'label': '위치'},
                            {'label': '상태', 'class': 'table__cell--center'}
                        ] %}
                        
                        {% set rows = [] %}
                        {% for asset in recent_assets %}
                            {% set category_name = {
                                1: '노트북', 2: '데스크탑', 3: '모니터', 
                                4: '서버', 5: '네트워크 장비', 6: '주변기기', 
                                7: '소프트웨어'
                            }.get(asset.category_id, '기타') %}
                            
                            {% set status_badge = {
                                'available': '<span class="status-badge status-badge--active">사용가능</span>',
                                'in_use': '<span class="status-badge status-badge--processing">사용중</span>',
                                'in_repair': '<span class="status-badge status-badge--pending">수리중</span>',
                                'disposed': '<span class="status-badge status-badge--error">폐기</span>',
                                'reserved': '<span class="status-badge status-badge--info">예약됨</span>'
                            }.get(asset.status, '<span class="status-badge status-badge--inactive">기타</span>') %}
                            
                            {% set _ = rows.append([
                                asset.asset_number,
                                asset.name,
                                category_name,
                                asset.location_name,
                                status_badge
                            ]) %}
                        {% endfor %}
                        
                        {{ simple_table(
                            headers=headers,
                            rows=rows,
                            variant='hover',
                            responsive=true
                        ) }}
                    {% else %}
                        <div class="empty-state">
                            <div class="empty-state__icon">
                                <i class="fas fa-inbox"></i>
                            </div>
                            <div class="empty-state__title">등록된 자산이 없습니다</div>
                            <div class="empty-state__description">새로운 자산을 등록해보세요.</div>
                            <div class="empty-state__action">
                                {{ btn('자산 등록', variant='primary', url=url_for('assets.form')) }}
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- 최근 활동 타임라인 -->
            <div class="content-section">
                <div class="content-section__header">
                    <h3 class="content-section__title">최근 활동</h3>
                </div>
                <div class="content-section__body">
                    <div class="activity-timeline">
                        <div class="activity-item">
                            <div class="activity-item__content">
                                <div class="activity-item__header">
                                    <div class="activity-item__title">자산 상태 변경</div>
                                    <div class="activity-item__time">오늘</div>
                                </div>
                                <div class="activity-item__description">
                                    노트북 HP EliteBook 850 G7 - 사용중 → 수리중<br>
                                    <small>담당자: 김관리</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="activity-item">
                            <div class="activity-item__content">
                                <div class="activity-item__header">
                                    <div class="activity-item__title">자산 등록</div>
                                    <div class="activity-item__time">어제</div>
                                </div>
                                <div class="activity-item__description">
                                    모니터 Dell P2720D 외 2종<br>
                                    <small>담당자: 이등록</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="activity-item">
                            <div class="activity-item__content">
                                <div class="activity-item__header">
                                    <div class="activity-item__title">계약 갱신</div>
                                    <div class="activity-item__time">2일 전</div>
                                </div>
                                <div class="activity-item__description">
                                    Microsoft Office 365 라이선스<br>
                                    <small>담당자: 박계약</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="activity-item">
                            <div class="activity-item__content">
                                <div class="activity-item__header">
                                    <div class="activity-item__title">자산 반출</div>
                                    <div class="activity-item__time">3일 전</div>
                                </div>
                                <div class="activity-item__description">
                                    노트북 HP EliteBook 840 G7 - 외근용<br>
                                    <small>담당자: 최사용</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-center mt-4">
                        {{ btn('모든 활동 보기', variant='text', icon='fa-chevron-right') }}
                    </div>
                </div>
            </div>

            <!-- 만료 임박 계약 -->
            <div class="content-section">
                <div class="content-section__header">
                    <h3 class="content-section__title">만료 임박 계약</h3>
                    <div class="content-section__actions">
                        {{ btn('전체보기', variant='primary', size='sm', url=url_for('contract.index')) }}
                    </div>
                </div>
                <div class="content-section__body content-section--flush">
                    {% if soon_expiring_contracts %}
                        {% set contract_headers = [
                            {'label': '계약번호', 'sortable': true},
                            {'label': '계약명', 'sortable': true},
                            {'label': '공급업체'},
                            {'label': '종료일', 'sortable': true},
                            {'label': '남은 기간', 'class': 'table__cell--right'},
                            {'label': '상태', 'class': 'table__cell--center'}
                        ] %}
                        
                        {% set contract_rows = [] %}
                        {% for contract in soon_expiring_contracts %}
                            {% set status_badge = {
                                'active': '<span class="status-badge status-badge--active">진행중</span>',
                                'expiring': '<span class="status-badge status-badge--pending">만료예정</span>',
                                'expired': '<span class="status-badge status-badge--error">만료됨</span>'
                            }.get(contract.status, '<span class="status-badge status-badge--inactive">기타</span>') %}
                            
                            {% set _ = contract_rows.append([
                                contract.contract_no,
                                contract.name,
                                contract.vendor,
                                contract.end_date,
                                contract.days_remaining + '일',
                                status_badge
                            ]) %}
                        {% endfor %}
                        
                        {{ simple_table(
                            headers=contract_headers,
                            rows=contract_rows,
                            variant='hover',
                            responsive=true
                        ) }}
                    {% else %}
                        <!-- 샘플 데이터 -->
                        {% set sample_contract_rows = [
                            ['CONT-2023-0145', 'Microsoft Office 365 구독', 'Microsoft', '2023-12-31', '7일', '<span class="status-badge status-badge--pending">만료예정</span>'],
                            ['CONT-2023-0192', 'Adobe Creative Cloud 라이선스', 'Adobe', '2024-01-15', '22일', '<span class="status-badge status-badge--pending">만료예정</span>'],
                            ['CONT-2022-0087', '서버실 유지보수 계약', '한국IT서비스', '2024-01-10', '17일', '<span class="status-badge status-badge--pending">만료예정</span>']
                        ] %}
                        
                        {{ simple_table(
                            headers=contract_headers,
                            rows=sample_contract_rows,
                            variant='hover',
                            responsive=true
                        ) }}
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- 사이드바 -->
        <div class="dashboard-layout__sidebar">
            <!-- 자산 카테고리 분포 -->
            <div class="content-section">
                <div class="content-section__header">
                    <h3 class="content-section__title">자산 카테고리 분포</h3>
                </div>
                <div class="content-section__body">
                    {% if category_stats %}
                        {% for category, count in category_stats.items() %}
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-2">
                                <span class="fw-medium">{{ category }}</span>
                                <span class="text-muted">{{ count }}</span>
                            </div>
                            <div class="progress-indicator">
                                <div class="progress-indicator__bar" 
                                     style="width: {{ (count / total_assets * 100)|int if total_assets > 0 else 0 }}%"></div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-state">
                            <div class="empty-state__icon">
                                <i class="fas fa-chart-pie"></i>
                            </div>
                            <div class="empty-state__title">차트 데이터 준비 중</div>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- 계약 유형 분포 -->
            <div class="content-section">
                <div class="content-section__header">
                    <h3 class="content-section__title">계약 유형 분포</h3>
                </div>
                <div class="content-section__body">
                    {% if contract_type_stats %}
                        {% for contract_type, count in contract_type_stats.items() %}
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-2">
                                <span class="fw-medium">{{ contract_type }}</span>
                                <span class="text-muted">{{ count }}</span>
                            </div>
                            <div class="progress-indicator progress-indicator--success">
                                <div class="progress-indicator__bar" 
                                     style="width: {{ (count / total_contracts * 100)|int if total_contracts > 0 else 0 }}%"></div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-state">
                            <div class="empty-state__icon">
                                <i class="fas fa-chart-pie"></i>
                            </div>
                            <div class="empty-state__title">차트 데이터 준비 중</div>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- 알림 -->
            <div class="content-section">
                <div class="content-section__header">
                    <h3 class="content-section__title">알림</h3>
                </div>
                <div class="content-section__body">
                    <div class="list-item">
                        <div class="list-item__content">
                            <div class="list-item__title">자산 실사 일정</div>
                            <div class="list-item__subtitle">2023년 2분기 자산 실사가 예정되어 있습니다.</div>
                            <div class="list-item__meta">3일 전</div>
                        </div>
                    </div>
                    
                    {% if expiring_contracts > 0 %}
                    <div class="list-item">
                        <div class="list-item__content">
                            <div class="list-item__title">계약 만료 알림</div>
                            <div class="list-item__subtitle">{{ expiring_contracts }}건의 계약이 곧 만료됩니다.</div>
                            <div class="list-item__meta">오늘</div>
                        </div>
                        <div class="list-item__actions">
                            {{ btn('확인', variant='text', size='sm', url=url_for('contract.index')) }}
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if maintenance_assets > 0 %}
                    <div class="list-item">
                        <div class="list-item__content">
                            <div class="list-item__title">수리중인 자산</div>
                            <div class="list-item__subtitle">{{ maintenance_assets }}대의 장비가 현재 수리중입니다.</div>
                            <div class="list-item__meta">오늘</div>
                        </div>
                        <div class="list-item__actions">
                            {{ btn('확인', variant='text', size='sm', url=url_for('assets.index', status='in_repair')) }}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/main/dashboard.new.css') }}">
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/pages/main/dashboard.js') }}" type="module"></script>
{% endblock %}